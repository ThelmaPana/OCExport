<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Assemble POC, environmental and UVP data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="04.assemble_files/libs/clipboard/clipboard.min.js"></script>
<script src="04.assemble_files/libs/quarto-html/quarto.js"></script>
<script src="04.assemble_files/libs/quarto-html/popper.min.js"></script>
<script src="04.assemble_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="04.assemble_files/libs/quarto-html/anchor.min.js"></script>
<link href="04.assemble_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="04.assemble_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="04.assemble_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="04.assemble_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="04.assemble_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#load-data" id="toc-load-data" class="nav-link active" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#round-coordinates-of-env-and-uvp-data-to-match-carbon-data" id="toc-round-coordinates-of-env-and-uvp-data-to-match-carbon-data" class="nav-link" data-scroll-target="#round-coordinates-of-env-and-uvp-data-to-match-carbon-data">Round coordinates of env and UVP data to match carbon data</a>
  <ul class="collapse">
  <li><a href="#env-data" id="toc-env-data" class="nav-link" data-scroll-target="#env-data">Env data</a></li>
  <li><a href="#uvp-data" id="toc-uvp-data" class="nav-link" data-scroll-target="#uvp-data">UVP data</a></li>
  </ul></li>
  <li><a href="#assemble-env-uvp-and-carbon-data" id="toc-assemble-env-uvp-and-carbon-data" class="nav-link" data-scroll-target="#assemble-env-uvp-and-carbon-data">Assemble env, UVP and carbon data</a></li>
  <li><a href="#subsample-env-variables" id="toc-subsample-env-variables" class="nav-link" data-scroll-target="#subsample-env-variables">Subsample env variables</a></li>
  <li><a href="#save-the-resulting-dataset" id="toc-save-the-resulting-dataset" class="nav-link" data-scroll-target="#save-the-resulting-dataset">Save the resulting dataset</a></li>
  </ul>
</nav>
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Assemble POC, environmental and UVP data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/00.carbon_data.Rdata"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/01.all_env.Rdata"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/03.uvp_profiles.Rdata"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(coast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="round-coordinates-of-env-and-uvp-data-to-match-carbon-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="round-coordinates-of-env-and-uvp-data-to-match-carbon-data">Round coordinates of env and UVP data to match carbon data</h2>
<p>Carbon data is given on a 2°×2° grid, so we need to round env and UVP coordinates to match the same grid. Carbon longitudes are odd so we need to floor longitude with <code>precision = 2</code> and then add 1 to the result. Carbon latitudes are even so we can just round with <code>precision = 2</code>.</p>
<section id="env-data" class="level3">
<h3 class="anchored" data-anchor-id="env-data">Env data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>env <span class="ot">&lt;-</span> env <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(lon, lat) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># floor longitude and add 1 because carbon longitudes are odd</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> <span class="fu">roundp</span>(lon, <span class="at">precision =</span> <span class="dv">2</span>, <span class="at">f =</span> floor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># round latitude because carbon latitudes are even</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">roundp</span>(lat, <span class="at">precision =</span> <span class="dv">2</span>, <span class="at">f =</span> round)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average all values on carbon pixels</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat) <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="uvp-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="uvp-data">UVP data</h3>
<p>We can start by plotting a map of UVP profiles.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>profiles <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">data =</span> world, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">group =</span> group), <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_quickmap</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s round the coordinates and replot the map. We also need to average UVP data on our new grid, but before that let’s also compute the number of UVP profiles per carbon pixel.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>profiles <span class="ot">&lt;-</span> profiles <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop profile identification</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>profile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># floor longitude and add 1 because carbon longitudes are odd</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> <span class="fu">roundp</span>(lon, <span class="at">precision =</span> <span class="dv">2</span>, <span class="at">f =</span> floor) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># round latitude because carbon latitudes are even</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">roundp</span>(lat, <span class="at">precision =</span> <span class="dv">2</span>, <span class="at">f =</span> round)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>n_profiles <span class="ot">&lt;-</span> profiles <span class="sc">%&gt;%</span> <span class="fu">count</span>(lon, lat)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>profiles <span class="ot">&lt;-</span> profiles <span class="sc">%&gt;%</span> </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average all values on carbon pixels</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat) <span class="sc">%&gt;%</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>profiles <span class="sc">%&gt;%</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">data =</span> world, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">group =</span> group), <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_quickmap</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>UVP profiles are now aligned on the 2°×2° grid. We can also plot the number of UVP profiles per pixel.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>n_profiles <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">data =</span> world, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">group =</span> group), <span class="at">fill =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">alpha =</span> n), <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_quickmap</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can notice a strong sampling in the California current and in the Peruvian upwelling.</p>
<p>Let’s have a quick look at Shannon diversity on this new grid.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(profiles, <span class="st">"ta_shannon"</span>, <span class="at">type =</span> <span class="st">"point"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="assemble-env-uvp-and-carbon-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="assemble-env-uvp-and-carbon-data">Assemble env, UVP and carbon data</h2>
<p>Since all three datasets use the same round coordinates, we can join them together. As a result, we will only get env and carbon data where UVP data is available.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> profiles <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(env,  <span class="at">by =</span> <span class="fu">join_by</span>(lon, lat)) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_c, <span class="at">by =</span> <span class="fu">join_by</span>(lon, lat)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lon, lat, <span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our dataset contains 581 points.</p>
<p>Now, we can plot POC data at locations of UVP profiles.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(df, <span class="st">"poc"</span>, <span class="at">type =</span> <span class="st">"point"</span>) <span class="sc">+</span> <span class="fu">scale_colour_cmocean</span>(<span class="at">name =</span> <span class="st">"matter"</span>) <span class="co"># manually add scale to show NA values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Or temperature.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(df, <span class="st">"temperature_mean"</span>, <span class="at">type =</span> <span class="st">"point"</span>) <span class="sc">+</span> <span class="fu">scale_colour_cmocean</span>(<span class="at">name =</span> <span class="st">"thermal"</span>) <span class="co"># manually add scale to show NA values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>In both cases, we notice that some POC and temperature data is not available at some UVP locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      lon               lat            datetime                     
 Min.   :-179.00   Min.   :-64.00   Min.   :2008-06-21 10:39:18.00  
 1st Qu.: -99.00   1st Qu.:-16.00   1st Qu.:2012-01-14 15:35:48.00  
 Median : -47.00   Median : 14.00   Median :2014-04-22 06:36:49.00  
 Mean   : -46.59   Mean   : 16.02   Mean   :2013-12-16 20:58:53.99  
 3rd Qu.:   1.00   3rd Qu.: 40.00   3rd Qu.:2015-06-15 22:13:35.00  
 Max.   : 179.00   Max.   : 80.00   Max.   :2018-07-22 12:45:04.00  
                                                                    
     ta_ric         ta_shannon      ta_pielou        m_dim1_mean     
 Min.   : 1.000   Min.   :0.000   Min.   :0.07554   Min.   :-5.3106  
 1st Qu.: 5.000   1st Qu.:0.995   1st Qu.:0.59818   1st Qu.:-1.9043  
 Median : 7.500   Median :1.455   Median :0.71674   Median :-0.9396  
 Mean   : 7.954   Mean   :1.338   Mean   :0.68812   Mean   :-0.5989  
 3rd Qu.:10.714   3rd Qu.:1.687   3rd Qu.:0.83307   3rd Qu.: 0.4105  
 Max.   :17.000   Max.   :2.384   Max.   :1.00000   Max.   : 5.3862  
                                  NA's   :2                          
   m_dim1_var      m_dim2_mean        m_dim2_var       m_dim3_mean     
 Min.   : 1.551   Min.   :-5.3897   Min.   : 0.7853   Min.   :-2.1010  
 1st Qu.: 9.683   1st Qu.:-0.2106   1st Qu.: 3.7749   1st Qu.:-0.1114  
 Median :12.458   Median : 0.4002   Median : 4.9466   Median : 0.4011  
 Mean   :13.309   Mean   : 0.6010   Mean   : 5.7560   Mean   : 0.4505  
 3rd Qu.:15.524   3rd Qu.: 1.7150   3rd Qu.: 6.2231   3rd Qu.: 0.9451  
 Max.   :60.778   Max.   : 5.2079   Max.   :25.4429   Max.   : 3.6427  
                                                                       
   m_dim3_var       m_dim4_mean        m_dim4_var      temperature_mean
 Min.   : 0.6714   Min.   :-3.2938   Min.   : 0.5942   Min.   :-1.317  
 1st Qu.: 3.8403   1st Qu.:-0.7851   1st Qu.: 3.6363   1st Qu.:15.449  
 Median : 5.3091   Median :-0.3051   Median : 4.6479   Median :21.177  
 Mean   : 5.3494   Mean   :-0.2462   Mean   : 5.0642   Mean   :18.513  
 3rd Qu.: 6.5724   3rd Qu.: 0.3643   3rd Qu.: 5.9559   3rd Qu.:26.237  
 Max.   :12.9479   Max.   : 2.2434   Max.   :21.5038   Max.   :29.883  
                                                       NA's   :24      
 salinity_mean   silicate_mean     phosphate_mean     nitrate_mean     
 Min.   :26.04   Min.   : 0.4805   Min.   :0.02884   Min.   : 0.01941  
 1st Qu.:34.25   1st Qu.: 1.3269   1st Qu.:0.12524   1st Qu.: 0.16532  
 Median :35.31   Median : 2.1418   Median :0.26026   Median : 0.66237  
 Mean   :34.84   Mean   : 3.6139   Mean   :0.37123   Mean   : 2.14866  
 3rd Qu.:35.96   3rd Qu.: 3.8117   3rd Qu.:0.54854   3rd Qu.: 2.55441  
 Max.   :39.82   Max.   :77.1928   Max.   :1.86037   Max.   :27.52491  
 NA's   :24      NA's   :24        NA's   :24        NA's   :24        
  oxygen_mean       pyc_mean         mld_mean      mld_argo_mean    
 Min.   :178.9   Min.   : 18.93   Min.   : 15.00   Min.   :  9.993  
 1st Qu.:207.9   1st Qu.: 53.13   1st Qu.: 16.47   1st Qu.: 29.652  
 Median :223.7   Median : 76.97   Median : 21.90   Median : 40.596  
 Mean   :247.1   Mean   : 79.11   Mean   : 27.92   Mean   : 43.124  
 3rd Qu.:256.7   3rd Qu.: 97.52   3rd Qu.: 32.19   3rd Qu.: 52.598  
 Max.   :445.2   Max.   :213.90   Max.   :180.54   Max.   :171.655  
 NA's   :24      NA's   :9        NA's   :9        NA's   :43       
  n_cline_mean     p_cline_mean     s_cline_mean      z_eu_mean     
 Min.   : 20.73   Min.   : 20.43   Min.   : 19.04   Min.   : 20.52  
 1st Qu.: 86.57   1st Qu.: 83.57   1st Qu.:107.97   1st Qu.: 48.36  
 Median :137.94   Median :145.14   Median :178.38   Median : 64.58  
 Mean   :168.99   Mean   :172.52   Mean   :212.18   Mean   : 63.58  
 3rd Qu.:233.13   3rd Qu.:249.09   3rd Qu.:315.18   3rd Qu.: 76.76  
 Max.   :440.06   Max.   :444.68   Max.   :458.63   Max.   :113.67  
 NA's   :9        NA's   :9        NA's   :9        NA's   :8       
    par_mean      temperature_sd    salinity_sd       silicate_sd      
 Min.   : 9.851   Min.   :0.1785   Min.   :0.01431   Min.   : 0.05983  
 1st Qu.:31.915   1st Qu.:1.1817   1st Qu.:0.05969   1st Qu.: 0.62750  
 Median :41.786   Median :1.8546   Median :0.09977   Median : 1.12645  
 Mean   :37.728   Mean   :1.8938   Mean   :0.27775   Mean   : 1.66675  
 3rd Qu.:45.585   3rd Qu.:2.3786   3rd Qu.:0.23418   3rd Qu.: 1.81084  
 Max.   :53.212   Max.   :5.9270   Max.   :3.10761   Max.   :11.32146  
 NA's   :8        NA's   :24       NA's   :24        NA's   :24        
  phosphate_sd       nitrate_sd        oxygen_sd          pyc_sd        
 Min.   :0.01762   Min.   :0.01328   Min.   : 1.621   Min.   :  0.8547  
 1st Qu.:0.05314   1st Qu.:0.16952   1st Qu.: 5.784   1st Qu.: 12.5961  
 Median :0.08309   Median :0.69060   Median : 8.088   Median : 28.9944  
 Mean   :0.11613   Mean   :1.13833   Mean   :10.035   Mean   : 36.2932  
 3rd Qu.:0.17553   3rd Qu.:1.88998   3rd Qu.:12.573   3rd Qu.: 46.0551  
 Max.   :0.38946   Max.   :5.36035   Max.   :52.614   Max.   :191.3394  
 NA's   :24        NA's   :24        NA's   :24       NA's   :9         
     mld_sd         mld_argo_sd         n_cline_sd        p_cline_sd      
 Min.   :  0.000   Min.   :  0.9067   Min.   :  1.246   Min.   :  0.6943  
 1st Qu.:  2.661   1st Qu.:  9.6106   1st Qu.: 20.859   1st Qu.: 20.6618  
 Median :  7.835   Median : 15.3336   Median : 44.855   Median : 49.2449  
 Mean   : 14.374   Mean   : 20.2456   Mean   : 48.821   Mean   : 54.1109  
 3rd Qu.: 20.056   3rd Qu.: 25.7978   3rd Qu.: 68.704   3rd Qu.: 83.7688  
 Max.   :164.617   Max.   :207.0769   Max.   :168.907   Max.   :170.3915  
 NA's   :9         NA's   :47         NA's   :9         NA's   :9         
   s_cline_sd         z_eu_sd            par_sd            poc          
 Min.   :  1.507   Min.   : 0.5984   Min.   : 1.528   Min.   :  0.0656  
 1st Qu.: 30.119   1st Qu.: 3.7790   1st Qu.: 7.230   1st Qu.: 34.5265  
 Median : 54.695   Median : 5.8716   Median :12.195   Median : 67.0653  
 Mean   : 60.471   Mean   : 6.5006   Mean   :11.192   Mean   :131.9038  
 3rd Qu.: 89.511   3rd Qu.: 8.9040   3rd Qu.:14.849   3rd Qu.:203.5440  
 Max.   :181.270   Max.   :17.0907   Max.   :21.488   Max.   :785.5005  
 NA's   :9         NA's   :8         NA's   :8        NA's   :49        </code></pre>
</div>
</div>
<p>Let’s get rid of these points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We still have 508 points in our dataset.</p>
<p>Let’s redraw our POC map.</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(df, <span class="st">"poc"</span>, <span class="at">type =</span> <span class="st">"point"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="04.assemble_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img column-body-outset" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="subsample-env-variables" class="level2">
<h2 class="anchored" data-anchor-id="subsample-env-variables">Subsample env variables</h2>
<p>For now, just keep <code>mean</code> variables and ignore <code>sd</code> and <code>var</code> variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#df &lt;- df %&gt;% select(-c(profile_id, lon, lat, datetime))</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#df &lt;- df %&gt;% select(lon, lat, poc, contains("ta_"), contains("mean"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="save-the-resulting-dataset" class="level2">
<h2 class="anchored" data-anchor-id="save-the-resulting-dataset">Save the resulting dataset</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(df, <span class="at">file =</span> <span class="fu">file.path</span>(data_dir, <span class="st">"04.all_data.Rdata"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>