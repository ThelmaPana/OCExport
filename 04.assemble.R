## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#| label: load data
#| output: false
source("utils.R")

load("data/00.carbon_data.Rdata")
load("data/01.env_data.Rdata")
load("data/02.uvp_profiles.Rdata")
rm(env_m, coast)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
env <- env_y %>%
  arrange(lon, lat) %>%
  mutate(
    # floor longitude and add 1 because carbon longitudes are odd
    lon = roundp(lon, precision = 2, f = floor) + 1,
    # round latitude because carbon latitudes are even
    lat = roundp(lat, precision = 2, f = round)
  ) %>%
  # Average all values on carbon pixels
  group_by(lon, lat) %>%
  summarise_all(mean, na.rm = TRUE) %>%
  ungroup()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
profiles %>% 
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat), alpha = 0.5, size = 0.5) +
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
profiles <- profiles %>%
  mutate(
    # floor longitude and add 1 because carbon longitudes are odd
    lon = roundp(lon, precision = 2, f = floor) + 1,
    # round latitude because carbon latitudes are even
    lat = roundp(lat, precision = 2, f = round)
  )

n_profiles <- profiles %>% count(lon, lat)

profiles <- profiles %>% 
  # Average all values on carbon pixels
  group_by(lon, lat) %>%
  summarise_all(mean, na.rm = TRUE) %>%
  ungroup()

profiles %>% 
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat), alpha = 0.5, size = 0.5) +
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
n_profiles %>% 
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat, alpha = n), size = 0.5) + 
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
profiles %>% 
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat, colour = t_shannon), size = 0.5) +
  scale_colour_viridis_c() +
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df <- profiles %>%
  left_join(env,  by = join_by(lon, lat)) %>%
  left_join(df_c, by = join_by(lon, lat))


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df %>%
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat, colour = poc), size = 0.5) +
  scale_colour_cmocean(name = "matter") +
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df %>%
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat, colour = temperature_mean), size = 0.5) +
  scale_colour_cmocean(name = "thermal") +
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(df)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df <- df %>% drop_na()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df %>%
  ggplot() +
  geom_polygon(data = world, aes(x = lon, y = lat, group = group), fill = "gray") +
  geom_point(aes(x = lon, y = lat, colour = poc), size = 0.5) +
  scale_colour_cmocean(name = "matter") +
  coord_quickmap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
df <- df %>% 
  select(poc, lon, lat, contains("t_"), contains("mean"))


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
save(df, file = file.path(data_dir, "03.all_data.Rdata"))

